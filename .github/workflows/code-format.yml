name: Code Format & Lint

on:
  push:
    branches:
      - "feature/**"
      - "feature/**/*"
  workflow_dispatch:

jobs:
  format-and-lint:
    name: Check and format the source code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      # Frontend: Node.js setup
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend packages
        working-directory: frontend
        run: npm ci

      - name: Run Prettier (Frontend)
        working-directory: frontend
        run: npm run format

      - name: Run ESLint (Frontend)
        working-directory: frontend
        run: npm run lint

      # Backend: Python setup
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.11"

      - name: Install backend packages
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run Black (Backend)
        working-directory: backend
        run: black app/ tests/

      - name: Run Ruff (Backend)
        working-directory: backend
        run: ruff check app/ tests/ --fix

      # Auto commit all changes
      - uses: stefanzweifel/git-auto-commit-action@v3.0.0
        with:
          commit_message: "chore: apply code formatter and linter (frontend & backend)"
          ref: ${{ github.head_ref }}
