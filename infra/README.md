# Okiteru - ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€Okiteruã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®AWSã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®CloudFormationãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

## ğŸ“‹ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
infra/
â”œâ”€â”€ dev/                          # é–‹ç™ºç’°å¢ƒ
â”‚   â”œâ”€â”€ infrastructure.yml        # CloudFormationãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ deploy.sh                 # ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ—ãƒ­ã‚¤
â”‚   â”œâ”€â”€ setup-parameters.sh       # Parameter Storeè¨­å®š
â”‚   â”œâ”€â”€ init-database.sh          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
â”‚   â”œâ”€â”€ init-cognito.sh           # ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
â”‚   â”œâ”€â”€ cleanup.sh                # ç’°å¢ƒå‰Šé™¤
â”‚   â””â”€â”€ README.md                 # è©³ç´°ã‚¬ã‚¤ãƒ‰
â”œâ”€â”€ codepipeline/                 # CI/CD
â”‚   â”œâ”€â”€ pipeline.yml              # CodePipelineãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ deploy-dev.sh             # Devç’°å¢ƒãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
â”‚   â”œâ”€â”€ deploy-staging.sh         # Stagingç’°å¢ƒãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
â”‚   â”œâ”€â”€ deploy-prod.sh            # Productionç’°å¢ƒãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
â”‚   â””â”€â”€ README.md                 # CI/CDã‚¬ã‚¤ãƒ‰
â””â”€â”€ README.md                     # æœ¬ãƒ•ã‚¡ã‚¤ãƒ«
```

## ğŸ—ï¸ ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£æ§‹æˆ

### ç’°å¢ƒåˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤

| ç’°å¢ƒ | ã‚¹ã‚¿ãƒƒã‚¯å | ãƒ–ãƒ©ãƒ³ãƒ | æ‰¿èª |
|------|-----------|---------|------|
| **Dev** | `okiteru-infrastructure-dev` | `develop` | ä¸è¦ |
| **Staging** | `okiteru-infrastructure-staging` | `staging` | ä¸è¦ |
| **Production** | `okiteru-infrastructure-prod` | `main` | **å¿…è¦** |

### ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹

å˜ä¸€ã®CloudFormationã‚¹ã‚¿ãƒƒã‚¯ã§ä»¥ä¸‹ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æ§‹ç¯‰ï¼š

**ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯:**
- VPC (10.0.0.0/16)
- Public Subnet Ã— 2
- Private Subnet Ã— 2
- Internet Gateway
- Route Tables
- Security Groups

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹:**
- RDS PostgreSQL 15.5
- db.t3.micro (é–‹ç™ºç’°å¢ƒ)
- Private Subneté…ç½®

**èªè¨¼:**
- Cognito User Pool
- Cognito User Pool Client
- User Groups (staff/manager)

**ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸:**
- S3 Bucket (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰) - ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ
- S3 Bucket (ç”»åƒ) - ãƒ‘ãƒ–ãƒªãƒƒã‚¯

**CDN/API:**
- CloudFront Distribution
- API Gateway REST API
- Lambda Function (Python 3.11)

**ãã®ä»–:**
- IAM Roles
- CloudWatch Logs

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### é–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# 1. é–‹ç™ºç’°å¢ƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd infra/dev

# 2. ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ä»˜ä¸
chmod +x *.sh

# 3. ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ15-20åˆ†ï¼‰
./deploy.sh

# 4. Parameter Storeè¨­å®šï¼ˆ1åˆ†ï¼‰
./setup-parameters.sh

# 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ï¼ˆ2-3åˆ†ï¼‰
./init-database.sh

# 6. ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆ1åˆ†ï¼‰
./init-cognito.sh

# 7. CI/CDã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
cd ../codepipeline
./deploy-dev.sh
```

è©³ç´°ã¯å„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®READMEã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š
- **[dev/README.md](dev/README.md)** - é–‹ç™ºç’°å¢ƒã®è©³ç´°ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰
- **[codepipeline/README.md](codepipeline/README.md)** - CI/CDè¨­å®šã‚¬ã‚¤ãƒ‰

## ğŸ“Š ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
                    ãƒ¦ãƒ¼ã‚¶ãƒ¼ (ãƒ–ãƒ©ã‚¦ã‚¶)
                            â†“ HTTPS
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   CloudFront     â”‚
                  â”‚  (CDN / HTTPS)   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                         â”‚
              â–¼                         â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  S3 Bucket  â”‚          â”‚ API Gateway  â”‚
      â”‚ (Frontend)  â”‚          â”‚  (REST API)  â”‚
      â”‚  (Private)  â”‚          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPC (10.0.0.0/16)                                    â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Public       â”‚  â”‚ Public       â”‚                â”‚
â”‚  â”‚ Subnet 1     â”‚  â”‚ Subnet 2     â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â†“                 â†“                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Private      â”‚  â”‚ Private      â”‚                â”‚
â”‚  â”‚ Subnet 1     â”‚  â”‚ Subnet 2     â”‚                â”‚
â”‚  â”‚              â”‚  â”‚              â”‚                â”‚
â”‚  â”‚ [Lambda]     â”‚  â”‚ [RDS]        â”‚                â”‚
â”‚  â”‚    â†“         â”‚  â”‚              â”‚                â”‚
â”‚  â”‚ [Cognito]    â”‚  â”‚ [S3 Photos]  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’° ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š

### é–‹ç™ºç’°å¢ƒï¼ˆæœˆé¡ï¼‰

| ã‚µãƒ¼ãƒ“ã‚¹ | ä»•æ§˜ | æœˆé¡ï¼ˆUSDï¼‰ |
|---------|------|------------|
| RDS (db.t3.micro) | 1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€20GB | $15-20 |
| Lambda | æœˆ100ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | $1-5 |
| S3 | 1GBä¿å­˜ | $1æœªæº€ |
| CloudFront | æœˆ10GBè»¢é€ | $1-3 |
| API Gateway | æœˆ100ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | $3-4 |
| Cognito | æœˆ1000 MAUä»¥ä¸‹ | ç„¡æ–™ |
| **åˆè¨ˆ** | | **$25-35/æœˆ** |

### æœ¬ç•ªç’°å¢ƒï¼ˆæœˆé¡ï¼‰

| ã‚µãƒ¼ãƒ“ã‚¹ | ä»•æ§˜ | æœˆé¡ï¼ˆUSDï¼‰ |
|---------|------|------------|
| RDS (db.t4g.small) | 1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€100GB | $40-50 |
| Lambda | æœˆ1000ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | $10-20 |
| S3 | 50GBä¿å­˜ | $1-2 |
| CloudFront | æœˆ100GBè»¢é€ | $8-12 |
| API Gateway | æœˆ1000ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | $30-40 |
| NAT Gateway | 1å°ï¼ˆå¿…è¦ãªå ´åˆï¼‰ | $30-40 |
| Cognito | æœˆ10,000 MAU | ç„¡æ–™ |
| **åˆè¨ˆ** | | **$120-200/æœˆ** |

## ğŸ”§ ä¸»è¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

### ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†

| ã‚¹ã‚¯ãƒªãƒ—ãƒˆ | ç”¨é€” | æ‰€è¦æ™‚é–“ |
|-----------|------|---------|
| `deploy.sh` | ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ—ãƒ­ã‚¤ | 15-20åˆ† |
| `setup-parameters.sh` | ç’°å¢ƒå¤‰æ•°è¨­å®š | 1åˆ† |
| `init-database.sh` | DBåˆæœŸåŒ– | 2-3åˆ† |
| `init-cognito.sh` | ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ | 1åˆ† |
| `cleanup.sh` | ç’°å¢ƒå®Œå…¨å‰Šé™¤ | 10-15åˆ† |

### CI/CDç®¡ç†

| ã‚¹ã‚¯ãƒªãƒ—ãƒˆ | ç”¨é€” |
|-----------|------|
| `deploy-dev.sh` | Devç’°å¢ƒãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ |
| `deploy-staging.sh` | Stagingç’°å¢ƒãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ |
| `deploy-prod.sh` | Productionç’°å¢ƒãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ |

## ğŸ“ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

```
1. ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º
   â†“
2. git push origin develop
   â†“
3. GitHubï¼ˆã‚½ãƒ¼ã‚¹æ›´æ–°ï¼‰
   â†“ webhookï¼ˆè‡ªå‹•æ¤œçŸ¥ï¼‰
4. CodePipelineï¼ˆèµ·å‹•ï¼‰
   â†“
5. CodeBuildï¼ˆãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆï¼‰
   - Frontend: npm run build
   - Backend: Lambda zipä½œæˆ
   â†“
6. è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
   - S3ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
   - CloudFront ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
   - Lambda ã‚³ãƒ¼ãƒ‰æ›´æ–°
```

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

**èªè¨¼æƒ…å ±ã®ç®¡ç†:**
- GitHub Token: AWS Secrets Manager
- Databaseèªè¨¼æƒ…å ±: Parameter Store (SecureString)
- Cognitoè¨­å®š: Parameter Store

**ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:**
- RDS: Private Subnetï¼ˆå¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰
- Lambda: VPCå†…é…ç½®
- S3 (Frontend): CloudFrontã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹
- S3 (Photos): ãƒ‘ãƒ–ãƒªãƒƒã‚¯èª­ã¿å–ã‚Šå¯èƒ½ï¼ˆæ›¸ãè¾¼ã¿ã¯Lambdaã®ã¿ï¼‰

**IAMæ¨©é™:**
- Lambdaå®Ÿè¡Œãƒ­ãƒ¼ãƒ«: æœ€å°æ¨©é™ã®åŸå‰‡
- CodeBuild: å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ã¸ã®é™å®šçš„ã‚¢ã‚¯ã‚»ã‚¹

## ğŸ†˜ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—æ™‚ã¯ä»¥ä¸‹ã‚’ç¢ºèªï¼š

1. **ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª**
   ```bash
   cat infra/dev/logs/deploy-*.log
   ```

2. **CloudFormationã‚¤ãƒ™ãƒ³ãƒˆç¢ºèª**
   ```bash
   aws cloudformation describe-stack-events \
     --stack-name okiteru-infrastructure-dev \
     --max-items 20
   ```

3. **å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**
   ```bash
   cd infra/dev
   ./cleanup.sh
   ```

è©³ç´°ã¯ [dev/README.md](dev/README.md) ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã€‚

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [AWS CloudFormation ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/cloudformation/)
- [AWS CodePipeline ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/codepipeline/)
- [FastAPI on AWS Lambda](https://www.serverless.com/examples/aws-python-fastapi-api)

---

**ä½œæˆæ—¥**: 2025-12-19
**æ›´æ–°æ—¥**: 2025-12-19
